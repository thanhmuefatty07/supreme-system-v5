<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supreme System V5 - Trading Dashboard</title>

    <!-- Minimal CSS framework for small bundle size -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Date handling -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <style>
        /* Custom optimizations for performance */
        .dashboard-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric-positive { color: #10b981; }
        .metric-negative { color: #ef4444; }
        .metric-neutral { color: #6b7280; }

        /* Loading states */
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive chart containers */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">âš¡ Supreme System V5</h1>
                    <span class="ml-4 px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full" id="status-indicator">
                        ðŸŸ¢ Live
                    </span>
                </div>

                <div class="flex items-center space-x-4">
                    <button onclick="exportTrades()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        ðŸ“Š Export Data
                    </button>
                    <button onclick="refreshDashboard()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        ðŸ”„ Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Portfolio Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="dashboard-card rounded-lg p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">ðŸ’°</span>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="text-sm font-medium text-gray-500">Total Balance</p>
                        <p class="text-2xl font-bold text-gray-900 loading" id="total-balance">$0.00</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card rounded-lg p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">ðŸ“ˆ</span>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="text-sm font-medium text-gray-500">Total P&L</p>
                        <p class="text-2xl font-bold loading" id="total-pnl">$0.00</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card rounded-lg p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">âš¡</span>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="text-sm font-medium text-gray-500">Active Positions</p>
                        <p class="text-2xl font-bold text-gray-900 loading" id="active-positions">0</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card rounded-lg p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-orange-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">ðŸŽ¯</span>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="text-sm font-medium text-gray-500">Win Rate</p>
                        <p class="text-2xl font-bold text-gray-900 loading" id="win-rate">0%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Portfolio Balance Chart -->
            <div class="dashboard-card rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Portfolio Balance</h3>
                    <select id="balance-timeframe" onchange="updateBalanceChart()" class="text-sm border-gray-300 rounded-md">
                        <option value="24">24 Hours</option>
                        <option value="72">3 Days</option>
                        <option value="168">7 Days</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="balance-chart"></canvas>
                </div>
            </div>

            <!-- P&L Chart -->
            <div class="dashboard-card rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Daily P&L</h3>
                    <span class="text-sm text-gray-500" id="pnl-period">Last 7 days</span>
                </div>
                <div class="chart-container">
                    <canvas id="pnl-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Trades Table -->
        <div class="dashboard-card rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Recent Trades</h3>
                <div class="flex items-center space-x-2">
                    <select id="trades-limit" onchange="updateTradesTable()" class="text-sm border-gray-300 rounded-md">
                        <option value="50">Last 50</option>
                        <option value="100">Last 100</option>
                        <option value="200">Last 200</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Side</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P&L</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strategy</th>
                        </tr>
                    </thead>
                    <tbody id="trades-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Trades will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System Status (Footer) -->
        <div class="mt-8 text-center text-sm text-gray-500">
            <p>Last updated: <span id="last-updated">Loading...</span> |
               Dashboard memory: <span id="dashboard-memory">0 MB</span> |
               System CPU: <span id="system-cpu">0%</span></p>
        </div>
    </main>

    <script>
        // Dashboard JavaScript - Optimized for performance
        class SupremeDashboard {
            constructor() {
                this.charts = {};
                this.updateInterval = 30000; // 30 seconds
                this.isUpdating = false;

                this.initializeCharts();
                this.loadInitialData();
                this.startAutoRefresh();
            }

            async loadInitialData() {
                await Promise.all([
                    this.updatePortfolioSummary(),
                    this.updateBalanceChart(),
                    this.updatePnLChart(),
                    this.updateTradesTable(),
                    this.updateSystemStatus()
                ]);
            }

            async updatePortfolioSummary() {
                try {
                    const response = await fetch('/api/portfolio/summary');
                    if (!response.ok) throw new Error('Failed to fetch portfolio summary');

                    const data = await response.json();

                    document.getElementById('total-balance').textContent = `$${parseFloat(data.total_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                    const pnlElement = document.getElementById('total-pnl');
                    const pnl = parseFloat(data.total_pnl || 0);
                    pnlElement.textContent = `$${pnl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    pnlElement.className = `text-2xl font-bold ${pnl >= 0 ? 'metric-positive' : 'metric-negative'}`;

                    document.getElementById('active-positions').textContent = data.active_positions || 0;

                    // Remove loading animation
                    document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));

                } catch (error) {
                    console.error('Error updating portfolio summary:', error);
                    this.showError('Failed to load portfolio data');
                }
            }

            initializeCharts() {
                // Portfolio Balance Chart
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                this.charts.balance = new Chart(balanceCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Portfolio Balance',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // P&L Chart
                const pnlCtx = document.getElementById('pnl-chart').getContext('2d');
                this.charts.pnl = new Chart(pnlCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Daily P&L',
                            data: [],
                            backgroundColor: function(context) {
                                const value = context.parsed.y;
                                return value >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                            },
                            borderColor: function(context) {
                                const value = context.parsed.y;
                                return value >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)';
                            },
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            async updateBalanceChart() {
                try {
                    const timeframe = document.getElementById('balance-timeframe').value;
                    const response = await fetch(`/api/portfolio/history?hours=${timeframe}`);
                    const data = await response.json();

                    const labels = data.map(item => moment(item.timestamp).format('MMM DD HH:mm'));
                    const balances = data.map(item => parseFloat(item.balance || 0));

                    this.charts.balance.data.labels = labels;
                    this.charts.balance.data.datasets[0].data = balances;
                    this.charts.balance.update();

                } catch (error) {
                    console.error('Error updating balance chart:', error);
                }
            }

            async updatePnLChart() {
                try {
                    const response = await fetch('/api/performance/metrics?days=7');
                    const data = await response.json();

                    const labels = data.map(item => moment(item.date).format('MMM DD'));
                    const pnls = data.map(item => parseFloat(item.daily_pnl || 0));

                    this.charts.pnl.data.labels = labels;
                    this.charts.pnl.data.datasets[0].data = pnls;
                    this.charts.pnl.update();

                    // Update win rate
                    if (data.length > 0) {
                        const avgWinRate = data.reduce((sum, item) => sum + (item.win_rate || 0), 0) / data.length;
                        document.getElementById('win-rate').textContent = `${avgWinRate.toFixed(1)}%`;
                    }

                } catch (error) {
                    console.error('Error updating P&L chart:', error);
                }
            }

            async updateTradesTable() {
                try {
                    const limit = document.getElementById('trades-limit').value;
                    const response = await fetch(`/api/trades/recent?limit=${limit}`);
                    const trades = await response.json();

                    const tbody = document.getElementById('trades-table-body');
                    tbody.innerHTML = '';

                    trades.forEach(trade => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${moment(trade.executed_at).format('MMM DD HH:mm')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${trade.symbol}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${trade.side === 'BUY' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${trade.side}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${parseFloat(trade.quantity).toFixed(4)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                $${parseFloat(trade.price).toLocaleString('en-US', {minimumFractionDigits: 2})}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${trade.pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                                $${parseFloat(trade.pnl || 0).toFixed(2)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${trade.strategy_name || 'Default'}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                } catch (error) {
                    console.error('Error updating trades table:', error);
                }
            }

            async updateSystemStatus() {
                try {
                    const response = await fetch('/api/system/status');
                    const status = await response.json();

                    document.getElementById('dashboard-memory').textContent = `${status.dashboard_memory_mb.toFixed(1)} MB`;
                    document.getElementById('system-cpu').textContent = `${status.cpu_percent.toFixed(1)}%`;
                    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

                } catch (error) {
                    console.error('Error updating system status:', error);
                }
            }

            startAutoRefresh() {
                setInterval(() => {
                    if (!this.isUpdating) {
                        this.isUpdating = true;
                        this.loadInitialData().finally(() => {
                            this.isUpdating = false;
                        });
                    }
                }, this.updateInterval);
            }

            showError(message) {
                const indicator = document.getElementById('status-indicator');
                indicator.innerHTML = 'ðŸ”´ Error';
                indicator.className = 'ml-4 px-3 py-1 bg-red-100 text-red-800 text-sm font-medium rounded-full';

                setTimeout(() => {
                    indicator.innerHTML = 'ðŸŸ¢ Live';
                    indicator.className = 'ml-4 px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full';
                }, 5000);
            }
        }

        // Global functions
        function refreshDashboard() {
            window.dashboard.loadInitialData();
        }

        function updateBalanceChart() {
            window.dashboard.updateBalanceChart();
        }

        function updateTradesTable() {
            window.dashboard.updateTradesTable();
        }

        function exportTrades() {
            window.open('/api/export/trades?days=30', '_blank');
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.dashboard = new SupremeDashboard();
        });
    </script>
</body>
</html>
