name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'prod/**'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  # Stage 1: Security Scanning
  security-scan:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ” Security scanning with Bandit
        run: |
          pip install bandit
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -ll  # Fail on high severity

      - name: ğŸ” Dependency vulnerability check
        run: |
          pip install safety
          safety check --json || true

      - name: ğŸ” Secrets scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: ğŸ“Š Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # Stage 2: Test Suite
  test-suite:
    name: ğŸ§ª Comprehensive Testing
    runs-on: ubuntu-latest
    needs: security-scan
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-xdist pytest-timeout

      - name: ğŸ§ª Run test suite with coverage
        env:
          COVERAGE_CORE: sysmon  # Python 3.12 fast mode
        run: |
          pytest \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            -n auto \
            --timeout=300 \
            -v

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: production-ready
          name: python-${{ matrix.python-version }}
          fail_ci_if_error: true

  # Stage 3: Load Testing
  load-test:
    name: ğŸ’¥ Load Testing
    runs-on: ubuntu-latest
    needs: test-suite
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Locust
        run: pip install locust

      - name: ğŸ’¥ Run load test
        run: |
          # Start application in background
          python -m src.main &
          APP_PID=$!
          sleep 10  # Wait for startup
          
          # Run load test
          locust \
            --headless \
            --users 1000 \
            --spawn-rate 50 \
            --run-time 5m \
            --host http://localhost:8000 \
            --html load-test-report.html
          
          # Stop application
          kill $APP_PID || true

      - name: ğŸ“Š Upload load test report
        uses: actions/upload-artifact@v4
        with:
          name: load-test-report
          path: load-test-report.html

  # Stage 4: Build & Push Docker Image
  build-image:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [test-suite, load-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: supremesystem/v5
          tags: |
            type=sha
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Stage 5: Deploy to Staging
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-image
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: ğŸš€ Deploy to staging
        run: |
          kubectl apply -f prod/deployment.yaml -n trading-staging
          kubectl wait --for=condition=ready pod -l app=supreme-system-v5 -n trading-staging --timeout=300s

      - name: âœ… Verify deployment
        run: |
          kubectl get pods -n trading-staging
          kubectl logs -l app=supreme-system-v5 -n trading-staging --tail=50

  # Stage 6: Smoke Tests on Staging
  smoke-test-staging:
    name: ğŸ”¥ Staging Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ”¥ Run smoke tests
        run: |
          pip install requests pytest
          pytest tests/smoke/ -v --staging

  # Stage 7: Deploy to Production (Manual Approval)
  deploy-production:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: smoke-test-staging
    environment: production  # Requires manual approval
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PROD }}

      - name: ğŸš€ Canary deployment (25% traffic)
        run: |
          # Deploy with canary strategy
          kubectl apply -f prod/deployment.yaml -n trading-prod
          
          # Wait for rollout
          kubectl rollout status deployment/supreme-system-v5 -n trading-prod

      - name: ğŸ“Š Monitor canary metrics (5 min)
        run: |
          echo "Monitoring canary deployment for 5 minutes..."
          sleep 300
          
          # Check error rate
          ERROR_RATE=$(curl -s http://prometheus:9090/api/v1/query?query=rate(http_requests_total{status=~"5.."}[5m]) | jq '.data.result[0].value[1]')
          
          if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
            echo "âŒ Error rate too high: $ERROR_RATE"
            exit 1
          fi

      - name: âœ… Promote to 100% traffic
        run: |
          echo "âœ… Canary successful, promoting to full deployment"
          kubectl set image deployment/supreme-system-v5 \
            supreme-system=supremesystem/v5:${{ github.sha }} \
            -n trading-prod

      - name: ğŸ“¢ Notify deployment success
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'ğŸ‰ Production deployment successful!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: success()

      - name: ğŸš¨ Rollback on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed, rolling back..."
          kubectl rollout undo deployment/supreme-system-v5 -n trading-prod
          
          # Notify team
          echo "Deployment rolled back to previous version"

      - name: ğŸ“¢ Notify deployment failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'âŒ Production deployment failed and rolled back'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: failure()

  # Stage 8: Post-Deployment Validation
  post-deploy-validation:
    name: âœ… Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate deployment
        run: |
          # Check all pods running
          kubectl get pods -n trading-prod -l app=supreme-system-v5
          
          # Check coverage still meets requirements
          kubectl exec -n trading-prod deployment/supreme-system-v5 -- \
            pytest --cov=src --cov-fail-under=80 -q
          
          # Check security features enabled
          kubectl exec -n trading-prod deployment/supreme-system-v5 -- \
            python -c "from src.security.zero_trust import get_zero_trust_manager; print('Zero Trust:', 'ENABLED')"

      - name: ğŸ“ˆ Generate deployment report
        run: |
          cat << EOF > deployment-report.md
          ## ğŸ‰ Production Deployment Report
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit**: ${{ github.sha }}
          **Triggered by**: ${{ github.actor }}
          
          ### Deployment Details
          - **Environment**: Production
          - **Strategy**: Canary (25% â†’ 100%)
          - **Replicas**: 3 (HPA: 3-10)
          - **Coverage**: 80%+ âœ…
          
          ### Security Features
          - **Zero Trust**: âœ… Enabled
          - **Post-Quantum Crypto**: âœ… Enabled
          - **Service Mesh**: âœ… Enabled
          - **Audit Logging**: âœ… Enabled
          
          ### Health Status
          - **All pods**: âœ… Running
          - **Health checks**: âœ… Passing
          - **Error rate**: < 0.5%
          - **Latency p95**: < 100ms
          
          ### Next Steps
          - Monitor metrics for 24 hours
          - Review audit logs
          - Verify zero trust policies
          - Check quantum crypto performance
          EOF
          
          cat deployment-report.md

      - name: ğŸ“ Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
